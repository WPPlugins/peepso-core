function PsActivity(){this.current_post=null,this.is_ajax_loading={},this.is_editing={}}PsActivity.prototype.init=function(){var a=this;this.$post_container=jQuery("#ps-activitystream"),jQuery(".comment-container").each(function(a,b){0===jQuery("div",b).length&&jQuery(this).hide()}),jQuery(".cstream-respond").each(function(a,b){0===jQuery("div",b).not(".comment-container").length&&jQuery(this).hide(),jQuery("textarea[name=comment]",b).ps_autosize()}),jQuery(document).on("click",".ps-js-content-excerpt-toggle",function(a){var b,c=jQuery(a.currentTarget),d=c.data("single-act");if(!d)return a.preventDefault(),a.stopPropagation(),b=c.closest(".ps-js-content-excerpt"),b.length&&b.hide().siblings(".ps-js-content-full").show(),!1}),jQuery(document).on("ps_activitystream_loaded peepso_repost_shown peepso_report_shown ps_activitystream_append",function(b){a.toggle_anchor_target(),a.setup_comment_textarea(),a.update_pinned_color(),a.parseXFBML()}),jQuery(document).trigger("ps_activitystream_loaded"),jQuery(document).on("ps_comment_addon_added ps_comment_addon_removed",function(a,b){var c,d;b=jQuery(b),c=b.closest(".ps-js-addons"),d=c.closest(".ps-textarea-wrapper").find("textarea"),"ps_comment_addon_added"===a.type?(b.siblings().hide(),c.show()):"ps_comment_addon_removed"===a.type&&(b.siblings(":visible").length?c.show():c.hide()),d.trigger("input")});jQuery(window).off("resize.activity-container").on("resize.activity-container",_.debounce(function(){var a=($PeepSo.screenSize(),jQuery(".ps-stream-container"));a.filter(":visible").width()<=480?a.addClass("ps-stream-container-narrow"):a.removeClass("ps-stream-container-narrow")},500)).trigger("resize.activity-container")},PsActivity.prototype.setup_comment_textarea=function(){var a=jQuery('[data-type="stream-newcomment"] textarea');a.off("keydown.peepso").on("keydown.peepso",jQuery.proxy(function(a){return this.on_comment_keydown(a)},this)),a.off("keyup.peepso").on("keyup.peepso",function(a){a.stopPropagation()})},PsActivity.prototype.on_comment_keydown=function(a){if(a.shiftKey||a.ctrlKey)return!0;if(13===(a.keyCode?a.keyCode:a.which)){if(/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent))return!0;var b=jQuery(a.target),c=""===jQuery.trim(b.val());if(ps_observer.apply_filters("comment_can_submit",{el:b,can_submit:!c}).can_submit)return this.comment_save(b.data("act-id")),a.preventDefault(),!1}return!0},PsActivity.prototype.toggle_anchor_target=function(){var a=new RegExp(location.host),b=jQuery(".ps-stream-content .cstream-attachment a, .ps-stream-content .content a, .ps-share-status-inner a").filter(function(){var b=jQuery(this).attr("href");return"http"===b.substring(0,4)&&!a.test(b)});0==peepsodata.open_in_new_tab?b.removeAttr("target"):b.attr("target","_blank")},PsActivity.prototype.action_like=function(a,b){if(this.action_like_progress)return!1;this.action_like_progress=!0;var c={act_id:b,uid:peepsodata.currentuserid},d=this,e=jQuery(a),f=jQuery(".ps-js-act-like--"+b),g=e.hasClass("liked"),h=+f.data("count")+(g?-1:1);f.html();return e.toggleClass("liked"),h<1?f.hide():1==h?(f.html('<a href="javascript:" onclick="return activity.show_likes('+b+');">1 '+peepsodata.like_text+"</a>"),f.show()):(f.html('<a href="javascript:" onclick="return activity.show_likes('+b+');">'+h+" "+peepsodata.like_text_plural+"</a>"),f.show()),$PeepSo.postJson("activity.like",c,function(a){d.action_like_progress=!1,a.success?(e.replaceWith(a.data.like_html),f.data("count",a.data.count),a.data.count>0?f.html(a.data.count_html).show():f.hide()):(psmessage.show("",a.errors[0]).fade_out(psmessage.fade_time),e.toggleClass("liked"),f.html(html),+f.data("count")>=1?f.show():f.hide())}),!1},PsActivity.prototype.action_repost=function(a){var b={act_id:a,uid:peepsodata.currentuserid,user_id:peepsodata.userid},c=jQuery("#repost-dialog .dialog-title").html();return content=jQuery("#ajax-loader-gif").html(),pswindow.show(c,content),$PeepSo.postJson("activity.ajax_show_post",b,function(b){if(0==b.success)return void pswindow.hide();var c=jQuery("#repost-dialog .dialog-content").html(),d=jQuery("#repost-dialog .dialog-action").html(),e=b.data.html.trim();e=e.replace("<p>","<span>").replace("</p>","<br/></span>").replace("<br/></span>","</span>"),c=c.replace("{post-content}",e),c=c.replace("{post-id}",a+""),pswindow.set_content(c).set_actions(d).refresh(),jQuery(document).trigger("peepso_repost_shown"),jQuery("#share-post-box","#ps-window").autosize(),jQuery("#ps-window").find("ul.ps-dropdown-menu").css({left:0,right:"auto"})}),!1},PsActivity.prototype.submit_repost=function(){var a=jQuery("#postbox-post-id","#ps-window").val(),b={content:jQuery("#share-post-box","#ps-window").val(),id:peepsodata.currentuserid,uid:peepsodata.currentuserid,repost:a,acc:jQuery("#cWindowContent input[name='repost_acc']").val(),type:"activity"};return b=ps_observer.apply_filters("postbox_req",b),$PeepSo.postJson("postbox.post",b,function(a){a.success&&(pswindow.hide(),"0"!==peepsodata.userid&&peepsodata.currentuserid!==peepsodata.userid||(jQuery(a.data.html).hide().prependTo("#ps-activitystream").fadeIn("slow",function(){jQuery(document).trigger("peepso_repost_added");var b=a.data.post_id;jQuery("#peepso-wrap .ps-js-activity--"+b+" .ps-dropdown-toggle").click(dropdown_toggle_click).on("mouseenter",dropdown_toggle_mouseenter),jQuery("#peepso-wrap .ps-js-activity--"+b+" .ps-dropdown-menu a").click(dropdown_toggle_a_click)}),jQuery("html, body").animate({scrollTop:jQuery("#ps-activitystream").offset().top},1e3)))}),!1},PsActivity.prototype.action_report=function(a){var b={act_id:a,uid:peepsodata.currentuserid,user_id:peepsodata.userid},c=jQuery("#activity-report-title").html();content=jQuery("#ajax-loader-gif").html(),pswindow.show(c,content),$PeepSo.postJson("activity.ajax_show_post",b,function(b){var c=jQuery("#activity-report-content").html(),d=b.data.html.trim();d=d.replace("<p>","<span>").replace("</p>","<br/></span>").replace("<br/></span>","</span>"),c=c.replace("{post-content}",d),c=c.replace("{post-id}",a+""),actions=jQuery("#activity-report-actions").html(),pswindow.set_content(c).set_actions(actions).refresh(),jQuery(document).trigger("peepso_report_shown")})},PsActivity.prototype.submit_report=function(){jQuery("#cWindowContent .report-error-div").hide();var a=jQuery("#postbox-report-popup #postbox-post-id","#ps-window").val(),b=jQuery("#rep_reason option:selected","#ps-window").val();if("0"===b){var c=jQuery("#report-error-select-reason").text();return jQuery("#cWindowContent .report-error-div").text(c).show(),!1}var d=ps_observer.apply_filters("activity_report_params",{act_id:a,uid:peepsodata.currentuserid,reason:b}),e=ps_observer.apply_filters("activity_report_action","activity.report");return $PeepSo.postJson(e,d,function(a){a.success?(jQuery(window).trigger("report.submitted",a),pswindow.set_content(a.notices[0]).fade_out(pswindow.fade_time)):(pswindow.hide(),psmessage.show("",a.errors[0]).fade_out(psmessage.fade_time))}),!1},PsActivity.prototype.action_delete=function(a,b){var c=this;return pswindow.confirm_delete(function(){var d=jQuery.extend({postid:a,uid:peepsodata.currentuserid},b||{});return $PeepSo.postJson("activity.delete",d,function(b){c.toggle_comment_box(a,!1),b.success&&window.location.reload()}),pswindow.hide(),!1}),!1},PsActivity.prototype.action_pin=function(a,b){var c={postid:a,pinstatus:b,uid:peepsodata.currentuserid};return $PeepSo.postJson("activity.pin",c,function(a){a.success&&window.location.reload()}),!1},PsActivity.prototype.action_remove_link_preview=function(a,b){var c=jQuery(".ps-js-activity--"+b);return c.length&&(c.find(".ps-stream-body .ps-stream-attachments").empty(),c.find(".ps-stream-actions .actaction-removepreview").remove(),peepso.postJson("activity.remove_link_preview",{postid:a,uid:peepsodata.currentuserid})),!1},PsActivity.prototype.on_commentbox_change=function(a){var b=jQuery(a),c=b.val();c.length>peepsodata.postsize&&(c=c.substring(0,peepsodata.postsize),b.val(c));var d=""===jQuery.trim(c),e=ps_observer.apply_filters("comment_show_button",{el:b,show:!d}),f=b.parents(".cstream-form-input").next(".cstream-form-submit");e.show?(f.show(),f.find(".ps-comment-actions").show(),f.find(".ps-button-action").removeAttr("disabled")):(f.hide(),f.find(".ps-comment-actions").hide(),f.find(".ps-button-action").attr("disabled","disabled"))},PsActivity.prototype.comment_save=function(a,b){if(!this.is_ajax_loading["save-comment-"+a]){var c=this,d=jQuery("#act-new-comment-"+a+" .cstream-form-text");b&&b.tagName&&(d=jQuery(b).closest("#act-new-comment-"+a).find(".cstream-form-text")),jQuery("#act-new-comment-"+a+" .ps-comment-loading").show(),jQuery("#act-new-comment-"+a+" .ps-comment-actions").hide();var e=jQuery(d),f=e.val();return req=ps_observer.apply_filters("comment_req",{act_id:a,uid:peepsodata.currentuserid,content:f,last:jQuery(".comment-container[data-act-id="+a+"] .cstream-comment:last").data("comment-id")},d),jQuery(document).trigger("ps_comment_beforesave",[a,d]),this.is_ajax_loading["save-comment-"+a]=!0,e.attr("disabled","disabled"),$PeepSo.postJson("activity.makecomment",req,function(b){if(c.is_ajax_loading["save-comment-"+a]=!1,e.removeAttr("disabled"),b.success){var f=jQuery(b.data.html);jQuery(".comment-container[data-act-id="+a+"]").show(),f.appendTo(".comment-container[data-act-id="+a+"]").hide().fadeIn(2e3),jQuery("#peepso-wrap").trigger("comment.saved",[a,d,req,f]),jQuery(document).trigger("ps_comment_save")}else psmessage.show("",b.errors[0]).fade_out(psmessage.fade_time);jQuery(document).trigger("ps_comment_aftersave",[a,d]),activity.comment_cancel(a),activity.current_post=null,jQuery("#act-new-comment-"+a+" .ps-comment-loading").hide(),jQuery("#act-new-comment-"+a+" .ps-comment-actions").hide(),jQuery("#act-new-comment-"+a+" .ps-button-action").attr("disabled","disabled"),void 0!==b.data.has_max_comments&&c.toggle_comment_box(a,b.data.has_max_comments)}),!1}},PsActivity.prototype.comment_action_edit=function(a,b){if(!(jQuery("#comment-item-"+a+" .cstream-content .cstream-edit").length>0)){var c=this,d=jQuery(b).closest("#comment-item-"+a);if(void 0===this.is_ajax_loading["comment-edit-"+a]||!1===this.is_ajax_loading["comment-edit-"+a]){this.is_ajax_loading["comment-edit-"+a]=!0;var e={postid:a,uid:peepsodata.currentuserid};$PeepSo.postJson("activity.editcomment",e,function(b){if(b.success){var e=jQuery(b.data.html);jQuery("[data-type='stream-comment-content']",d).first().hide().after(e),jQuery(".ps-comment-media",d).hide(),jQuery("#peepso-wrap").trigger("comment_edit.shown",[a,e]),ps_observer.do_action("comment_edit",a,e),jQuery(".cstream-edit textarea",d).on("input propertychange",function(){jQuery(this).val().length>peepsodata.postsize&&jQuery(this).val(jQuery(this).val().substring(0,peepsodata.postsize))}).autosize(),c.is_ajax_loading["comment-edit-"+a]=!1}})}return!1}},PsActivity.prototype.option_canceleditcomment=function(a,b){var c=jQuery(b).closest("#comment-item-"+a);return c.length>0&&(jQuery(".cstream-edit",c).remove(),jQuery("[data-type='stream-comment-content']",c).show(),jQuery(".ps-comment-media",c).show()),!1},PsActivity.prototype.option_savecomment=function(a,b){var c=jQuery(b).closest("#comment-item-"+a);if(c.length>0){var d=jQuery(".cstream-edit textarea",c).val();jQuery(".cstream-edit textarea",c).attr("disabled","disabled"),jQuery(".ps-edit-loading",c).show(),jQuery(".cstream-edit button",c).hide();var e=jQuery(".cstream-edit textarea",c),f=ps_observer.apply_filters("comment_req",{postid:a,uid:peepsodata.currentuserid,post:d},e);jQuery(document).trigger("ps_comment_beforesave",[a,e]),$PeepSo.postJson("activity.savecomment",f,function(b){b.success?(jQuery(".cstream-edit",c).remove(),jQuery("[data-comment-id="+a+"] [data-type='stream-comment-content']").html(b.data.html),jQuery("[data-type='stream-comment-content']",c).show(),jQuery("[data-comment-id="+a+"] .cstream-content > .cstream-attachments").html(b.data.attachments),jQuery(".cstream-content > .cstream-attachments",c).show(),jQuery("span.ps-stream-status-action",c).html(b.data.actions),jQuery(document).trigger("ps_comment_save")):(psmessage.show("",b.notices[0]),jQuery(".cstream-edit button",c).show(),jQuery(".ps-edit-loading",c).hide(),jQuery(".cstream-edit textarea",c).removeAttr("disabled"))})}return!1},PsActivity.prototype.comment_action_delete=function(a){var b=this;pswindow.confirm_delete(function(){var c={postid:a,uid:peepsodata.currentuserid};return $PeepSo.postJson("activity.delete",c,function(c){b.toggle_comment_box(a,!1),c.success&&jQuery(".ps-comment-item[data-comment-id="+a+"]").remove(),pswindow.hide()}),!1})},PsActivity.prototype.comment_action_remove_preview=function(a){var b=jQuery("#comment-item-"+a);return b.length&&(b.find(".ps-comment-media").empty(),b.find(".actaction-removepreview").remove(),peepso.postJson("activity.remove_link_preview",{postid:a,uid:peepsodata.currentuserid})),!1},PsActivity.prototype.comment_action_report=function(a){var b={act_id:a};return $PeepSo.postJson("activity.ajax_show_comment",b,function(b){var c=jQuery("#activity-report-title").html(),d=jQuery("#activity-report-content").html(),e=b.data.html.trim();e=e.replace("<p>","<span>").replace("</p>","<br/></span>").replace("<br/></span>","</span>"),d=d.replace("{post-content}",e),d=d.replace("{post-id}",a+""),ps_observer.add_filter("activitystream_notice_container",function(a,b){return"#comment-item-"+b+" .cstream-more"},10,2),actions=jQuery("#activity-report-actions").html(),pswindow.show(c,d).set_actions(actions).refresh(),jQuery("#ps-window").one("pswindow.hidden",function(){ps_observer.remove_filter("activitystream_notice_container",function(a,b){return"#comment-item-"+b+" .cstream-more"},10)})}),!1},PsActivity.prototype.comment_action_reply=function(a,b,c,d){return peepso.comment.reply(a,b,c,d),!1},PsActivity.prototype.comment_action_like=function(a,b){if(!this.comment_action_like_progress){this.comment_action_like_progress=!0;var c={act_id:b,uid:peepsodata.currentuserid},d=this,e=jQuery(a),f=jQuery(".ps-js-act-like--"+b),g=e.hasClass("liked"),h=+f.data("count")+(g?-1:1);f.html();return e.toggleClass("liked"),h<1?f.hide():1==h?(f.html('<a href="javascript:" onclick="return activity.show_likes('+b+');">1 '+peepsodata.like_text+"</a>"),f.show()):(f.html('<a href="javascript:" onclick="return activity.show_likes('+b+');">'+h+" "+peepsodata.like_text_plural+"</a>"),f.show()),$PeepSo.postJson("activity.like",c,function(a){d.comment_action_like_progress=!1,a.success?(e.replaceWith(a.data.like_html),f.data("count",a.data.count),a.data.count>0?f.html(a.data.count_html).show():f.hide()):(psmessage.show("",a.errors[0]).fade_out(psmessage.fade_time),e.toggleClass("liked"),f.html(html),+f.data("count")>=1?f.show():f.hide())}),!1}},PsActivity.prototype.comment_cancel=function(a){var b=jQuery("#act-new-comment-"+a),c=b.find(".cstream-form-text");return b.find(".cstream-form-submit").hide(),b.find(".ps-js-commentbox-addons").hide(),c.val("").trigger("autosize.resize"),ps_observer.apply_filters("comment_cancel",c),!1},PsActivity.prototype.show_likes=function(a){var b={act_id:a,uid:peepsodata.currentuserid},c=this,d="likes-"+a;return this.is_ajax_loading[d]&&(this.is_ajax_loading[d].ret&&this.is_ajax_loading[d].ret.abort(),this.is_ajax_loading[d]=!1),this.is_ajax_loading[d]=$PeepSo.postJson("activity.get_like_names",b,function(b){jQuery("#act-like-"+a+" a").replaceWith(b.data.html),c.is_ajax_loading[d]=!1}),!1},PsActivity.prototype.show_comments=function(a,b){return peepso.comment.show_previous(a,b),!1},PsActivity.prototype.option_edit=function(a,b){var c="edit-post-"+b;if(!this.is_editing[c]){this.is_editing[c]=!0;var d=jQuery(".ps-js-activity--"+b),e=d.find(".ps-js-activity-content"),f=d.find(".ps-js-activity-edit"),g=d.find(".ps-stream-actions"),h=d.find(".ps-stream-body .cstream-attachments"),i=d.find(".ps-js-activity-extras");return f.ps_postbox({fetch:function(b,c){peepso.postJson("activity.editpost",{uid:peepsodata.currentuserid,postid:a},function(a){a.success&&b.update(a.data),c()})},cancel:jQuery.proxy(function(a){this.is_editing[c]=!1,f.ps_postbox("destroy"),e.show()},this),submit:jQuery.proxy(function(a,d,j){d=jQuery.extend({},d,{uid:peepsodata.currentuserid,act_id:b}),d.post=d.content,delete d.content,peepso.postJson("activity.savepost",d,jQuery.proxy(function(a){a.success?(this.is_editing[c]=!1,f.ps_postbox("destroy"),e.html(a.data.html).show(),h.html(a.data.attachments),g.html(a.data.actions),i.html(a.data.extras||"")):psmessage.show("",a.errors[0]),jQuery(document).trigger("peepso_post_edit_saved"),j()},this))},this)}),e.hide(),f.show(),!1}},PsActivity.prototype.option_canceledit=function(a){this.is_editing["edit-post-"+a]=!1;var b=jQuery(".ps-js-activity--"+a);return b.length>0&&(jQuery(".cstream-edit",b).remove(),jQuery(".cstream-attachment",b).show()),!1},PsActivity.prototype.option_cancel_edit_description=function(a){var b=jQuery(".ps-js-modal-attachment--"+a);return b.length>0&&(jQuery(".cstream-edit",b).remove(),jQuery(".cstream-attachment",b).show()),!1},PsActivity.prototype.option_savepost=function(a){var b=jQuery(".ps-js-activity--"+a);if(b.length>0){var c=jQuery(".cstream-edit textarea",b).val();jQuery(".cstream-edit textarea",b).attr("disabled","disabled"),jQuery(".ps-edit-loading",b).show(),jQuery(".cstream-edit button",b).hide();var d=ps_observer.apply_filters("postbox_req_edit",{act_id:a,uid:peepsodata.currentuserid,post:c},jQuery(".cstream-edit textarea",b));$PeepSo.postJson("activity.savepost",d,jQuery.proxy(function(c){jQuery(".cstream-edit",b).remove(),c.success?(this.is_editing["edit-post-"+a]=!1,jQuery(".ps-stream-body .cstream-attachment",b).html(c.data.html),jQuery(".ps-stream-body .cstream-attachments",b).html(c.data.attachments),jQuery(".ps-stream-actions",b).html(c.data.actions)):psmessage.show("",c.errors[0]),jQuery(".ps-stream-body .cstream-attachment, .ps-stream-body .cstream-attachments",b).show(),jQuery(document).trigger("peepso_post_edit_saved")},this))}return!1},PsActivity.prototype.option_save_description=function(a,b,c){var d=jQuery(".ps-js-modal-attachment--"+a);if(d.length>0){var e=jQuery(".cstream-edit textarea",d),f=e.val();jQuery(".cstream-edit textarea",d).attr("disabled","disabled"),jQuery(".ps-edit-loading",d).show(),jQuery(".cstream-edit button",d).hide();var g={act_id:a,type:b,object_id:c,uid:peepsodata.currentuserid,description:f};g=ps_observer.apply_filters("caption_req",g,e),$PeepSo.postJson("activity.save_description",g,function(a){jQuery(".cstream-edit",d).remove(),jQuery(".ps-stream-attachment",d).html(a.data.html).show()})}return!1},PsActivity.prototype.option_hide=function(a){var b={act_id:a,uid:peepsodata.currentuserid};return $PeepSo.postJson("activity.hidepost",b,function(b){b.success&&jQuery(".ps-js-activity--"+a).remove()}),!1},PsActivity.prototype.option_block=function(a,b){var c={uid:peepsodata.currentuserid,user_id:b};return $PeepSo.postJson("activity.blockuser",c,function(b){b.success&&jQuery(".ps-js-activity--"+a).remove()}),!1},PsActivity.prototype.change_post_privacy=function(a,b){var c,d,e,f,g;a=jQuery(a),c=jQuery(".ps-js-privacy--"+b),d=c.find(".ps-dropdown-toggle"),d.find("a"),e=d.find("i").attr("class"),f=a.find("i").attr("class"),d.find("i").attr("class",f),d.css("opacity",.5),g={uid:peepsodata.currentuserid,user_id:peepsodata.userid,act_id:b,acc:a.data("option-value"),_wpnonce:peepsodata.peepso_nonce};var h=this.change_post_privacy;return h._xhr||(h._xhr={}),h._xhr[b]&&h._xhr[b].ret.abort(),h._xhr[b]=peepso.postJson("activity.change_post_privacy",g,function(a){d.css("opacity",""),a.has_errors&&(d.find("i").attr("class",e),psmessage.show("",a.errors[0]).fade_out(psmessage.fade_time))}),!1},PsActivity.prototype.toggle_comment_box=function(a,b){var c=jQuery("#act-new-comment-"+a);if(c.length<=0){var d=jQuery("#comment-item-"+a);if(d.length<=0&&(d=jQuery(".ps-js-activity--"+a)),d.length>0){c=d.parent();var e=(d.parent().attr("id")+"").split("-").pop();c=jQuery("#act-new-comment-"+e)}}return!(c.length<=0)&&(b?c.hide():c.show(),!1)},PsActivity.prototype.delete_activity=function(a,b){var c=jQuery.extend({act_id:a,uid:peepsodata.currentuserid,_wpnonce:jQuery("#_delete_nonce").val()},b||{}),d=jQuery("[data-act-delete-id="+a+"]"),e="";return d.length>0&&(e=d.text()),pswindow.confirm_delete(function(){$PeepSo.postJson("activity.ajax_delete_activity",c,function(a){a.success?window.location.reload():psmessage.show("",a.errors[0]).fade_out(psmessage.fade_time)})},e),!1},PsActivity.prototype.edit_activity_description=function(a,b,c){var d=jQuery(".ps-js-modal-attachment--"+a);if(!(d.find(".cstream-edit textarea").length>0)){var e={act_id:a,type:b,object_id:c,uid:peepsodata.currentuserid};return this.edit_activity_description_xhr&&this.edit_activity_description_xhr.ret&&this.edit_activity_description_xhr.ret.abort(),this.edit_activity_description_xhr=$PeepSo.postJson("activity.edit_description",e,function(a){if(a.success){var b=jQuery(a.data.html);d.find(".ps-stream-attachment").first().hide().after(b),jQuery("#peepso-wrap").trigger("post_edit.shown",[a.data.act_id,b]),d.find(".cstream-edit textarea").on("input propertychange",function(){jQuery(this).val().length>peepsodata.postsize&&jQuery(this).val(jQuery(this).val().substring(0,peepsodata.postsize))}).autosize().focus()}}),!1}},PsActivity.prototype.remove_broken_thumbnails=function(){jQuery(".ps-media-thumbnail img").each(function(){var a=new Image,b=this;a.onerror=function(){jQuery(b).closest(".ps-media-thumbnail").remove()},a.src=b.src})},PsActivity.prototype.update_pinned_color=function(){var a,b=jQuery(".ps-stream__post-pin span");b.length&&(a=b.eq(0).closest(".ps-stream").find("a").eq(0),b.css("backgroundColor",a.css("color")))},function(a,b){a.extend(PsActivity.prototype,function(a){return{__constructor:function(){this.isPermalink=peepsodata.activity&&+peepsodata.activity.is_permalink,this.enableLoadMoreButton=+peepsodata.loadmore_enable,a(a.proxy(this.onDocumentLoaded,this))},onDocumentLoaded:function(){this.$el=a("#ps-activitystream"),this.$el.length&&!this.isPermalink&&this.onWindowScroll()},parseXFBML:_.throttle(function(){peepso.util.fbParseXFBML()},2e3),load_more:function(){return a.Deferred(a.proxy(function(b){var c=+peepsodata.currentuserid,d=a("#ps-activitystream"),e=a(".post-ajax-loader"),f=a("#peepso_stream_id").val(),g=+(this._load_more_page||peepsodata.activity_limit_page_load)+1,h=ps_observer.apply_filters("show_more_posts",{uid:c,user_id:peepsodata.userid,stream_id:f,page:g});e.removeClass("hidden"),this._load_more_loading=!0,peepso.disableAuth().disableError().postJson("activity.show_posts_per_page",h,a.proxy(function(b){var c;b.data.found_posts>0?(c=a(b.data.posts),c.appendTo(d).hide().fadeIn(1e3,function(){a(document).trigger("ps_activitystream_loaded")}),a("textarea[name=comment]",c).autosize(),a("#div-show-more-posts").remove(),this._load_more_page=g):this._load_more_end=!0,this._load_more_loading=!1,e.addClass("hidden"),this._load_more_end&&a("#ps-no-more-posts").show(),c||a(document).trigger("ps_activitystream_loaded")},this)).ret.done(a.proxy(function(){b.resolveWith(this,arguments)},this)).fail(a.proxy(function(){b.rejectWith(this,arguments)},this)),a(document).on("peepso_login_shown",function(){a(".post-ajax-loader").toggleClass("hidden")})},this))},onWindowScroll:_.throttle(function(){var b,c,d,e=a("#ps-activitystream");e.length&&(c=+peepsodata.activity_limit_below_fold,c=c>0?c:3,b=e.children(".ps-js-activity").slice(0-c),b=b.eq(0),b.length&&(d=this.enableLoadMoreButton?b.eq(0).offset():b.get(0).getBoundingClientRect(),d.top<(window.innerHeight||document.documentElement.clientHeight)?this._load_more_loading||this._load_more_end||this.load_more().done(function(){this.onWindowScroll()}):this.enableLoadMoreButton?(this.$btnKeepLoading=a(peepsodata.activity.template_load_more).insertAfter(e),this.$btnKeepLoading.one("click",a.proxy(function(){this.$btnKeepLoading.remove(),this.enableLoadMoreButton=!1,this.onWindowScroll()},this))):this._onWindowScrollEnabled||(this._onWindowScrollEnabled=!0,a(window).on("scroll",a.proxy(this.onWindowScroll,this)).trigger("scroll"))))},1e3)}}(a)),activity=new PsActivity,a(function(){activity.remove_broken_thumbnails(),activity.init(),activity.__constructor()})}(jQuery);