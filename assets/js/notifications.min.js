!function(a,b){ps_notification=new(function(a){function b(){a(a.proxy(function(){_.defer(a.proxy(function(){var b=a("#peepso-wrap").length,c=a("#wpadminbar").find(".psnotification-toggle").length;(b||c)&&this.start()},this))},this)),ps_observer.add_action("notification_start",a.proxy(this.start,this))}return b.prototype={_get_latest_interval:3e4,_get_latest_count:function(){peepso.disableAuth().disableError().postJson("notificationsajax.get_latest_count",null,a.proxy(function(b){var c;b.success&&!b.session_timeout&&(c=0,a.each(b.data,function(b,d){var e,f,g=a("."+b),h=Math.max(0,d.count);c+=h,g.length&&(f=g.find(".ps-js-counter"),e=+f.eq(0).text(),f.length&&e!==h&&(f.html(h).css("display",h>0?"":"none"),h>0&&g.psnotification("clear_cache")))}),this._update_titlebar(c),ps_observer.do_action("notification_update",b))},this))},_update_titlebar:function(a){var b=(document.title||"").replace(/^\(\d+\)\s*/,"");a>0&&(b="("+a+") "+b),document.title!==b&&(document.title=b)},hide:function(b){var c,d,e;void 0!==b&&(d=this.hide,e="_progress_"+b,d[e]||(d[e]=!0,c=a(".ps-js-notifications").find(".ps-js-notification--"+b).map(function(){return a(this).parent(".ps-notification__wrapper").get(0)}),c.css("opacity",.5),peepso.postJson("notificationsajax.hide",{note_id:b},a.proxy(function(a){delete d[e],a.success?(c.remove(),ps_observer.do_action("notification_restart")):c.css("opacity","")},this))))},mark_as_read:function(b){var c,d,e=null;b&&(e={note_id:b}),c=this.mark_as_read,d="_progress_"+(b||""),c[d]||(c[d]=!0,$elems=a(".ps-js-notifications").find(".ps-js-notification"+(b?"--"+b:"")).map(function(){return a(this).parent(".ps-notification__wrapper").get(0)}),$elems.css("opacity",.5),peepso.postJson("notificationsajax.mark_as_read",e,a.proxy(function(a){delete c[d],$elems.css("opacity",""),a.success&&($elems.find(".ps-notification--unread").removeClass("ps-notification--unread"),$elems.find(".ps-js-btn-markasread").remove(),ps_observer.do_action("notification_restart"))},this)))},mark_all_as_read:function(){this.mark_as_read(null)},start:function(){!this._started&&+peepsodata.currentuserid&&(this._started=!0,this._get_latest_count(),this._get_latest_timer=setInterval(a.proxy(this._get_latest_count,this),this._get_latest_interval),a(window).on("peepso_auth_required",a.proxy(function(){clearInterval(this._get_latest_timer)},this)),ps_observer.add_filter("pschat_mark_as_read",this.restart,10,1,this),ps_observer.add_action("notification_restart",this.restart,10,1,this))},restart:function(){+peepsodata.currentuserid&&(clearInterval(this._get_latest_timer),this._get_latest_count(),this._get_latest_timer=setInterval(a.proxy(this._get_latest_count,this),this._get_latest_interval))}},b}(a))}(jQuery),function(a){function b(b,c){var d=this;return this.popover=null,this.popover_list=null,this.popover_footer=null,this.popover_header=null,this._notifications={},this.init=function(c){_opts={view_all_text:peepsodata.view_all_text,view_all_link:null,source:null,request:{per_page:10,page:1},header:null,paging:!1,fetch:null},this.opts=ps_observer.apply_filters("peepso_notification_plugin_options",_opts),this._content_is_fetched=!1,a.extend(!0,this.opts,c),a(b).addClass("psnotification-toggle"),this.popover=a("<div>"),this.popover_list=a("<div>").css({maxHeight:"40vh",overflow:"auto"}),this.popover_list.bind("mousewheel",a.proxy(function(b,c){var d=a(b.currentTarget);c>0&&0===d.scrollTop()?b.preventDefault():c<0&&d.scrollTop()==d.get(0).scrollHeight-d.innerHeight()&&b.preventDefault()},this)),a(b).append(this.popover),!1===_.isNull(this.opts.header)&&(this.popover_header=a("<div/>"),this.popover_header.addClass("ps-popover-header app-box-header").append(this.opts.header).append("<div class='clearfix' />"),this.popover.append(this.popover_header)),this.popover.append(this.popover_list),this.popover_list.addClass("ps-notifications ps-notifications--empty"),this.popover.addClass("ps-popover app-box").hide(),this.opts.paging&&this.init_pagination(),!1===_.isNull(this.opts.view_all_link)&&(this.popover_footer=a("<div/>"),this.popover_footer.addClass("ps-popover-footer app-box-footer").append("<a href='"+this.opts.view_all_link+"'>"+this.opts.view_all_text+"</a>"),this.popover.append(this.popover_footer))},this.fetch=function(a){var b=this.opts.request,c=(this.opts.method||"").toLowerCase();_.isFunction(this.opts.fetch)&&!1===(b=this.opts.fetch.call(this,b))||(this._notifications={},this.fetch_stop(),this.fetch_xhr=$PeepSo["get"===c?"getJson":"postJson"](this.opts.source,b,function(b){b.success?(d._content_is_fetched=!0,d._data=b.data,d._notifications=b.data.notifications,d._errors=!1,d._notifications.length>0&&d.opts.request.page++):b.errors&&(d._content_is_fetched=!0,d._errors=b.errors),"function"==typeof a&&a()}))},this.fetch_stop=function(){this.fetch_xhr&&(this.fetch_xhr.abort?this.fetch_xhr.abort():this.fetch_xhr.ret&&this.fetch_xhr.ret.abort&&this.fetch_xhr.ret.abort())},this.refresh=function(){this.popover_list.find(".ps-notification__wrapper").remove(),this._content_is_fetched=!1,this.load_page(function(){d.opts.paging&&d.popover_list.trigger("scroll")})},this.onClick=function(b){if(!(_.isFunction(d.opts.before_click)&&!1===d.opts.before_click()||d.popover.has(a(b.target)).length>0)){b.preventDefault();var c=d.opts.lazy,e=d.popover.is(":visible");d.show(),!c&&!e&&d.load_page(function(){d.opts.paging&&d.popover_list.trigger("scroll")})}},this.render=function(){a.each(this._notifications,function(b,c){var e=a("<div class='ps-notification__wrapper'></div>");e.html(c).hide(),e.appendTo(d.popover_list).fadeIn("slow")}),a(b).trigger("notifications.shown",[a.extend(b,this)]),a(document.body).hasClass("wp-admin")&&a(b).find("a").attr("target","_blank"),this.popover_list.toggleClass("ps-notifications--empty",0===this.popover_list.find(".ps-notification__wrapper").length)},this.show=function(){this.popover.slideToggle({duration:"fast",start:function(){d.popover.position({my:"right top",at:"bottom",of:a("i",b),using:function(b,c){"right"===c.horizontal?(a(this).removeClass("flipped"),b.left+=40):(a(this).addClass("flipped"),b.left-=40),b.top+=10,a(this).css(b)}})},done:function(){a(document).on("mouseup.notification_click",function(c){a(b).is(c.target)||0!==a(b).has(c.target).length||(d.popover.hide(),a(document).off("mouseup.notification_click"))})}})},this.init_pagination=function(){this.popover_list.on("scroll",function(){d._content_is_fetched&&a(this).scrollTop()+a(this).innerHeight()>=a(this)[0].scrollHeight&&(d._content_is_fetched=!1,d.load_page(function(){d._notifications&&_.isEmpty(d._notifications)?d.popover_list.off("scroll"):d.popover_list.trigger("scroll")}))})},this.load_page=function(b){if(!1===this._content_is_fetched){var c=this.popover_list.nextAll(".ps-popover-error"),e=this.popover_list.nextAll(".ps-popover-loading");c.length&&c.remove(),e.length||(e=a("<div class='ps-popover-loading'><img src='"+peepsodata.loading_gif+"'/></div>"),this.popover_list.after(e)),this.fetch_stop(),setTimeout(function(){d.fetch(function(){e.remove(),d._errors&&(c=a("<div class=ps-popover-error />"),a.each(d._errors,function(b,d){a("<div />").html(d).appendTo(c)}),d.popover_list.after(c)),d.render(),typeof b==typeof Function&&b(),"function"==typeof d.opts.after_load&&d.opts.after_load.apply(d)})},500)}},this.clear_cache=function(){this.popover_list.find(".ps-notification__wrapper").remove(),this.popover.hide(),this.opts.request.page=1,this._content_is_fetched=!1},this.init(c),a(b).on("click",this.onClick),this}a.fn.psnotification=function(c){return this.each(function(){if(a.data(this,"plugin_psnotification")){var d=a.data(this,"plugin_psnotification");if(_.isFunction(d[c]))return d[c].call(d)}else a.data(this,"plugin_psnotification",new b(this,c))})},ps_observer.add_action("notification_clear_cache",function(b){b=b||"ps-js-notifications",a("."+b).psnotification("clear_cache")},10,1)}(jQuery),jQuery(function(a){a(".dropdown-notification").psnotification({view_all_link:peepsodata.notifications_page,source:"notificationsajax.get_latest",request:{per_page:5},paging:!0})});