!function(a,b){PsPageAutoload=function(a){function b(){return this.init.apply(this,arguments)}return b.prototype={init:function(b){if(!b)throw new Error("CSS prefix is not supplied!");return this._css_prefix=b,this._config_loadmore_enable=+peepsodata.loadmore_enable,a(_.bind(this.onDocumentLoaded,this)),this},onDocumentLoaded:function(){if(this._search_$ct=a(this._css_prefix).eq(0),this._search_$trigger=a(this._css_prefix+"-triggerscroll"),this._search_$loading=a(this._css_prefix+"-loading"),this._search_$nomore=a(peepsodata.activity.template_no_more).hide().insertBefore(this._search_$trigger),!this._search_$ct.length)return!1;this._search()},_search_url:"",_search_params:{},_search_loadmore_enable:null,_search:function(){this._search_toggle_autoscroll("off"),this._search_toggle_loading("show"),this._search_$ct.empty(),this._search_$nomore.hide(),this._search_params.page<=1&&(this._search_loadmore_enable=this._config_loadmore_enable,this._search_$loadmore&&(this._search_$loadmore.remove(),this._search_$loadmore=null)),this._search_debounced()},_search_next:function(){this._search_toggle_autoscroll("off"),this._search_toggle_loading("show"),this._search_params.page++,this._search_debounced()},_search_debounced:_.debounce(function(){this._fetch(this._search_params).done(function(a){var b=this._search_render_html(a);this._search_toggle_loading("hide"),b?(this._search_$ct.append(b),this._search_toggle_autoscroll("on")):this._search_$nomore.show()}).fail(function(a){this._search_toggle_loading("hide"),this._search_params.page<=1?this._search_$ct.html(a.join("<br>")):this._search_$nomore.show()})},500),_search_render_html:function(){throw new Error("This method must be implemented by subclass!")},_search_toggle_loading:function(b){"show"===b?(clearTimeout(this._search_toggle_loading_timer),this._search_$loading.show()):"hide"===b&&(this._search_toggle_loading_timer=setTimeout(a.proxy(function(){this._search_$loading.hide()},this),1e3))},_search_toggle_autoscroll:function(b){var c="scroll"+this._css_prefix,d=a(window);"off"===b?d.off(c):"on"===b&&this._search_$trigger.length&&(this._search_loadmore_enable?this._search_should_load_more()?this._search_next():(this._search_$loadmore=a(peepsodata.activity.template_load_more).insertAfter(this._search_$ct),this._search_$loadmore.one("click",a.proxy(function(a){this._search_$loadmore.remove(),this._search_$loadmore=null,this._search_loadmore_enable=!1,this._search_next()},this))):d.off(c).on(c,a.proxy(function(){this._search_should_load_more()&&this._search_next()},this)).trigger(c))},_search_get_items:function(){return a()},_search_should_load_more:function(){var a,b,c=+peepsodata.activity_limit_below_fold,d=this._search_get_items();return c=c>0?c:3,this._search_params.limit&&(c*=this._search_params.limit),a=d.slice(0-c).eq(0),!!(a.length&&(b=this._search_loadmore_enable?a.eq(0).offset():a.get(0).getBoundingClientRect(),b.top<(window.innerHeight||document.documentElement.clientHeight)))},_fetch:function(b){return a.Deferred(a.proxy(function(c){b=a.extend({},b),_.isUndefined(b.limit)||(b.limit*=2),this._fetch_xhr&&this._fetch_xhr.abort(),this._fetch_xhr=peepso.getJson(this._search_url,b,a.proxy(function(a){a.success?c.resolveWith(this,[a.data]):c.rejectWith(this,[a.errors])},this))},this))}},b}(a)}(jQuery);